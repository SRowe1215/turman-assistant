<script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
<script>
  emailjs.init("bBYfl0lnqtkXqqhQQ");

  const flows = {
    "Refrigerator": [...],
    "Oven / Stove": [...],
    "AC / Heat": [...],
    "Plumbing / Leak": [...],
    "Electrical / Power": [...],
    "Roof / Ceiling": [...],
    "Other": [
      { q: "Briefly describe your issue:", key: "note" },
      { q: "Anything else that might help?", key: "details" }
    ]
  };

  const summaries = {
    "Refrigerator": (a) => `Tenant reports the fridge is ${a.running}. Light: ${a.light}. Outlet tested: ${a.outlet}. Breaker: ${a.breaker}. ${a.note}`,
    "Oven / Stove": (a) => {
      const type = a.type?.toLowerCase() === "electric" ? "an electric stove or oven" :
                   a.type?.toLowerCase() === "gas" ? "a gas stove or oven" : "a stove or oven";
      return `Tenant reports an issue with ${type}. Not working: ${a.function}. Breaker: ${a.breaker}. ${a.note}`;
    },
    "AC / Heat": (a) => `HVAC issue. Outside temp: ${a.priority}. Air: ${a.air}. Thermostat: ${a.thermostat}. Breaker: ${a.breaker}. Unit noise: ${a.unit}. ${a.note}`,
    "Plumbing / Leak": (a) => `Leak reported: ${a.flow} from ${a.source}. Shutoff used: ${a.shutoff}. Repeat: ${a.repeat}. ${a.note}`,
    "Electrical / Power": (a) => `Power issue in: ${a.area}. Breakers checked: ${a.breaker}. Test result: ${a.test}. Smell/burn marks: ${a.burn}. ${a.note}`,
    "Roof / Ceiling": (a) => `Ceiling issue in ${a.room}. Active: ${a.leak}. Damage: ${a.damage}. Attic cause: ${a.attic}. ${a.note}`,
    "Other": (a) => `Tenant reports: ${a.note}. Additional details: ${a.details || "None"}`
  };

  let currentFlow = [], answers = {}, currentIndex = 0, selectedType = "";

  document.getElementById("issueType").addEventListener("change", function () {
    selectedType = this.value;
    if (!selectedType) return;
    currentFlow = flows[selectedType];
    answers = {};
    currentIndex = 0;
    document.getElementById("questionBox").classList.remove("hidden");
    document.getElementById("summarySection").classList.add("hidden");
    askQuestion();
  });

  function askQuestion() {
    if (currentIndex < currentFlow.length) {
      document.getElementById("questionText").innerText = currentFlow[currentIndex].q;
      document.getElementById("answerInput").value = "";
      document.getElementById("answerInput").focus();
    } else {
      document.getElementById("questionBox").classList.add("hidden");
      document.getElementById("summarySection").classList.remove("hidden");
      const summary = summaries[selectedType]?.(answers) || answers.note;
      document.getElementById("summaryText").innerText = summary;
    }
  }

  function submitAnswer() {
    const key = currentFlow[currentIndex].key;
    const val = document.getElementById("answerInput").value.trim();
    if (!val) return;
    answers[key] = val;
    currentIndex++;
    askQuestion();
  }

  document.getElementById("workOrderForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const params = {
      tenant_name: document.getElementById("name").value || "Not provided",
      tenant_address: document.getElementById("address").value || "Not provided",
      tenant_phone: document.getElementById("phone").value || "Not provided",
      tenant_email: document.getElementById("email").value || "Not provided",
      summary: document.getElementById("summaryText").innerText || "No summary generated"
    };

    emailjs.send("service_gm4dva6", "template_fuki8ci", params)
      .then(() => {
        document.getElementById("workOrderForm").classList.add("hidden");
        document.getElementById("confirmation").classList.remove("hidden");
      })
      .catch((err) => {
        alert("Submission failed. Please try again.");
        console.error("EmailJS Error:", err);
      });
  });

  // Attach the Next button handler
  window.submitAnswer = submitAnswer;
</script>
